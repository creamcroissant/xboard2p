name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

env:
  GO_VERSION: '1.25'
  NODE_VERSION: '20'

jobs:
  build-frontend:
    name: Build Frontend Assets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build User Frontend
        working-directory: web/user-vite
        run: |
          npm ci
          npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web/user-vite/dist
          if-no-files-found: error

  build-binaries:
    name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
    runs-on: ubuntu-latest
    needs: build-frontend
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            ext: ''
          - goos: linux
            goarch: arm64
            ext: ''
          - goos: darwin
            goarch: amd64
            ext: ''
          - goos: darwin
            goarch: arm64
            ext: ''
          - goos: windows
            goarch: amd64
            ext: '.exe'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/user-vite/dist

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version info
        id: version
        run: |
          echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          echo "commit=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "build_time=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_OUTPUT"

      - name: Build binaries
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          EXT: ${{ matrix.ext }}
        run: |
          set -euo pipefail

          mkdir -p dist/release

          XBOARD_BIN="xboard-${GOOS}-${GOARCH}${EXT}"
          AGENT_BIN="agent-${GOOS}-${GOARCH}${EXT}"

          echo "Building ${XBOARD_BIN}"
          go build -trimpath \
            -ldflags "-s -w -X main.Version=${{ steps.version.outputs.version }} -X main.Commit=${{ steps.version.outputs.commit }} -X main.BuildTime=${{ steps.version.outputs.build_time }}" \
            -o "dist/release/${XBOARD_BIN}" \
            ./cmd/xboard

          echo "Building ${AGENT_BIN}"
          go build -trimpath \
            -ldflags "-s -w" \
            -o "dist/release/${AGENT_BIN}" \
            ./cmd/agent

          sha256sum "dist/release/${XBOARD_BIN}" > "dist/release/${XBOARD_BIN}.sha256"
          sha256sum "dist/release/${AGENT_BIN}" > "dist/release/${AGENT_BIN}.sha256"

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/release/*
          if-no-files-found: error

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-binaries
    steps:
      - uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/release
          pattern: release-*
          merge-multiple: true

      - name: Verify expected binaries exist
        run: |
          set -euo pipefail
          test -f dist/release/xboard-linux-amd64
          test -f dist/release/xboard-linux-arm64
          test -f dist/release/xboard-darwin-amd64
          test -f dist/release/xboard-darwin-arm64
          test -f dist/release/xboard-windows-amd64.exe

          test -f dist/release/agent-linux-amd64
          test -f dist/release/agent-linux-arm64
          test -f dist/release/agent-darwin-amd64
          test -f dist/release/agent-darwin-arm64
          test -f dist/release/agent-windows-amd64.exe

      - name: Verify deploy script shell compatibility
        run: |
          set -euo pipefail

          sh -n deploy/common.sh deploy/install.sh deploy/panel.sh deploy/agent.sh deploy/agent-bootstrap.sh
          bash -n deploy/common.sh deploy/install.sh deploy/panel.sh deploy/agent.sh deploy/agent-bootstrap.sh

          WORKDIR_SH="$(mktemp -d)"
          WORKDIR_BASH="$(mktemp -d)"
          trap 'rm -rf "${WORKDIR_SH}" "${WORKDIR_BASH}"' EXIT

          cp dist/release/agent-linux-amd64 "${WORKDIR_SH}/agent"
          cp deploy/install.sh "${WORKDIR_SH}/install.sh"
          cp deploy/panel.sh "${WORKDIR_SH}/panel.sh"
          cp deploy/agent.sh "${WORKDIR_SH}/agent.sh"
          cp deploy/common.sh "${WORKDIR_SH}/common.sh"
          cp deploy/agent.service "${WORKDIR_SH}/agent.service"
          cp deploy/agent-bootstrap.sh "${WORKDIR_SH}/agent-bootstrap.sh"
          cp deploy/agent-bootstrap.sha256 "${WORKDIR_SH}/agent-bootstrap.sha256"

          cp dist/release/agent-linux-amd64 "${WORKDIR_BASH}/agent"
          cp deploy/install.sh "${WORKDIR_BASH}/install.sh"
          cp deploy/panel.sh "${WORKDIR_BASH}/panel.sh"
          cp deploy/agent.sh "${WORKDIR_BASH}/agent.sh"
          cp deploy/common.sh "${WORKDIR_BASH}/common.sh"
          cp deploy/agent.service "${WORKDIR_BASH}/agent.service"
          cp deploy/agent-bootstrap.sh "${WORKDIR_BASH}/agent-bootstrap.sh"
          cp deploy/agent-bootstrap.sha256 "${WORKDIR_BASH}/agent-bootstrap.sha256"

          mkdir -p "${WORKDIR_SH}/local/local/releases/download/local" "${WORKDIR_BASH}/local/local/releases/download/local"
          cp dist/release/agent-linux-amd64 "${WORKDIR_SH}/local/local/releases/download/local/agent-linux-amd64"
          cp dist/release/agent-linux-amd64 "${WORKDIR_BASH}/local/local/releases/download/local/agent-linux-amd64"

          chmod +x "${WORKDIR_SH}/agent" "${WORKDIR_SH}/install.sh" "${WORKDIR_SH}/panel.sh" "${WORKDIR_SH}/agent.sh" "${WORKDIR_SH}/common.sh" "${WORKDIR_SH}/agent-bootstrap.sh"
          chmod +x "${WORKDIR_BASH}/agent" "${WORKDIR_BASH}/install.sh" "${WORKDIR_BASH}/panel.sh" "${WORKDIR_BASH}/agent.sh" "${WORKDIR_BASH}/common.sh" "${WORKDIR_BASH}/agent-bootstrap.sh"

          if [ "$(sha256sum "${WORKDIR_SH}/agent.sh" | awk '{print $1}')" != "$(awk '/[[:space:]]agent\.sh$/ {print $1}' "${WORKDIR_SH}/agent-bootstrap.sha256')" ]; then
            echo "agent.sh checksum mismatch against deploy/agent-bootstrap.sha256" >&2
            exit 1
          fi
          if [ "$(sha256sum "${WORKDIR_SH}/common.sh" | awk '{print $1}')" != "$(awk '/[[:space:]]common\.sh$/ {print $1}' "${WORKDIR_SH}/agent-bootstrap.sha256')" ]; then
            echo "common.sh checksum mismatch against deploy/agent-bootstrap.sha256" >&2
            exit 1
          fi
          if [ "$(sha256sum "${WORKDIR_SH}/agent.service" | awk '{print $1}')" != "$(awk '/[[:space:]]agent\.service$/ {print $1}' "${WORKDIR_SH}/agent-bootstrap.sha256')" ]; then
            echo "agent.service checksum mismatch against deploy/agent-bootstrap.sha256" >&2
            exit 1
          fi

          (
            cd "${WORKDIR_SH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/out" sh ./install.sh --agent-only
            test -x "${WORKDIR_SH}/out/agent"
            test -f "${WORKDIR_SH}/out/agent_config.yml"
          )

          (
            cd "${WORKDIR_BASH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/out" bash ./install.sh --agent-only
            test -x "${WORKDIR_BASH}/out/agent"
            test -f "${WORKDIR_BASH}/out/agent_config.yml"
          )

          (
            cd "${WORKDIR_SH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/bootstrap-out" XBOARD_BOOTSTRAP_REF=local \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
            XBOARD_AGENT_SCRIPT_URL="file://${WORKDIR_SH}/agent.sh" XBOARD_COMMON_SCRIPT_URL="file://${WORKDIR_SH}/common.sh" \
            sh ./agent-bootstrap.sh \
              --repo local/local \
              --service-url "file://${WORKDIR_SH}/agent.service" \
              --checksum-url "file://${WORKDIR_SH}/agent-bootstrap.sha256"
            test -x "${WORKDIR_SH}/bootstrap-out/agent"
            test -f "${WORKDIR_SH}/bootstrap-out/agent_config.yml"
          )

          (
            cd "${WORKDIR_BASH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/bootstrap-out" XBOARD_BOOTSTRAP_REF=local \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_BASH}" \
            XBOARD_AGENT_SCRIPT_URL="file://${WORKDIR_BASH}/agent.sh" XBOARD_COMMON_SCRIPT_URL="file://${WORKDIR_BASH}/common.sh" \
            bash ./agent-bootstrap.sh \
              --repo local/local \
              --service-url "file://${WORKDIR_BASH}/agent.service" \
              --checksum-url "file://${WORKDIR_BASH}/agent-bootstrap.sha256"
            test -x "${WORKDIR_BASH}/bootstrap-out/agent"
            test -f "${WORKDIR_BASH}/bootstrap-out/agent_config.yml"
          )

          cp "${WORKDIR_SH}/agent.service" "${WORKDIR_SH}/agent.service.local-fallback"
          cp "${WORKDIR_SH}/agent.service" "${WORKDIR_SH}/agent.service.bad"
          printf '\n# checksum mismatch fixture\n' >> "${WORKDIR_SH}/agent.service.bad"

          (
            cd "${WORKDIR_SH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/bootstrap-checksum-fallback-out" XBOARD_BOOTSTRAP_REF=local \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
            XBOARD_AGENT_SCRIPT_URL="file://${WORKDIR_SH}/agent.sh" XBOARD_COMMON_SCRIPT_URL="file://${WORKDIR_SH}/common.sh" \
            XBOARD_AGENT_SERVICE_FILE="${WORKDIR_SH}/agent.service.local-fallback" \
            XBOARD_BOOTSTRAP_DOWNLOAD_STRICT=0 \
            sh ./agent-bootstrap.sh \
              --repo local/local \
              --service-url "file://${WORKDIR_SH}/agent.service.bad" \
              --checksum-url "file://${WORKDIR_SH}/agent-bootstrap.sha256"
            test -x "${WORKDIR_SH}/bootstrap-checksum-fallback-out/agent"
            test -f "${WORKDIR_SH}/bootstrap-checksum-fallback-out/agent_config.yml"
          )

          (
            cd "${WORKDIR_SH}"
            if XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/bootstrap-checksum-strict-out" XBOARD_BOOTSTRAP_REF=local \
              XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
              XBOARD_AGENT_SCRIPT_URL="file://${WORKDIR_SH}/agent.sh" XBOARD_COMMON_SCRIPT_URL="file://${WORKDIR_SH}/common.sh" \
              XBOARD_AGENT_SERVICE_FILE="${WORKDIR_SH}/agent.service.local-fallback" \
              XBOARD_BOOTSTRAP_DOWNLOAD_STRICT=1 \
              sh ./agent-bootstrap.sh \
                --repo local/local \
                --service-url "file://${WORKDIR_SH}/agent.service.bad" \
                --checksum-url "file://${WORKDIR_SH}/agent-bootstrap.sha256"; then
              echo "agent-bootstrap should fail when agent.service checksum mismatches in strict mode" >&2
              exit 1
            fi
          )

          (
            cd "${WORKDIR_SH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/bootstrap-download-fallback-out" XBOARD_BOOTSTRAP_REF=local \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
            XBOARD_AGENT_SCRIPT_URL="file://${WORKDIR_SH}/agent.sh" XBOARD_COMMON_SCRIPT_URL="file://${WORKDIR_SH}/common.sh" \
            XBOARD_AGENT_SERVICE_FILE="${WORKDIR_SH}/agent.service.local-fallback" \
            XBOARD_BOOTSTRAP_DOWNLOAD_STRICT=0 \
            sh ./agent-bootstrap.sh \
              --repo local/local \
              --service-url "file://${WORKDIR_SH}/missing-agent.service" \
              --checksum-url "file://${WORKDIR_SH}/agent-bootstrap.sha256"
            test -x "${WORKDIR_SH}/bootstrap-download-fallback-out/agent"
            test -f "${WORKDIR_SH}/bootstrap-download-fallback-out/agent_config.yml"
          )

      - name: Set up Go for install config check
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Verify install config compatibility (gRPC-only)
        run: |
          set -euo pipefail

          WORKDIR="$(mktemp -d)"
          VALIDATE_GO="${GITHUB_WORKSPACE}/tmp_validate_agent_config.go"
          trap 'rm -rf "${WORKDIR}"; rm -f "${VALIDATE_GO}"' EXIT

          cp dist/release/agent-linux-amd64 "${WORKDIR}/agent"
          cp deploy/install.sh "${WORKDIR}/install.sh"
          cp deploy/panel.sh "${WORKDIR}/panel.sh"
          cp deploy/agent.sh "${WORKDIR}/agent.sh"
          cp deploy/common.sh "${WORKDIR}/common.sh"

          chmod +x "${WORKDIR}/agent" "${WORKDIR}/install.sh" "${WORKDIR}/panel.sh" "${WORKDIR}/agent.sh" "${WORKDIR}/common.sh"

          (
            cd "${WORKDIR}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR}/out" sh ./install.sh --agent-only
            test -f "${WORKDIR}/out/agent_config.yml"
          )

          cat > "${VALIDATE_GO}" <<'EOF'
          package main

          import (
            "fmt"
            "os"

            agentcfg "github.com/creamcroissant/xboard/internal/agent/config"
          )

          func main() {
            if len(os.Args) != 2 {
              fmt.Fprintln(os.Stderr, "usage: validate_agent_config <path>")
              os.Exit(2)
            }
            if _, err := agentcfg.Load(os.Args[1]); err != nil {
              fmt.Fprintln(os.Stderr, err)
              os.Exit(1)
            }
          }
          EOF

          if ! grep -Eq '^[[:space:]]*grpc:' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml missing grpc section" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*enabled:[[:space:]]*true[[:space:]]*$' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml missing grpc.enabled=true" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*address:[[:space:]]*""[[:space:]]*$' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml should require manual grpc.address override" >&2
            exit 1
          fi
          if grep -Eq '^[[:space:]]*address:[[:space:]]*"127\.0\.0\.1:9090"[[:space:]]*$' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml must not keep default grpc.address=127.0.0.1:9090" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*panel:' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml missing panel section" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*host_token:[[:space:]]*""[[:space:]]*$' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml should require manual panel.host_token override" >&2
            exit 1
          fi
          if grep -Eq '^[[:space:]]*host_token:[[:space:]]*"change_me"[[:space:]]*$' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml must not keep placeholder panel.host_token" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*traffic:' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml missing traffic section" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*type:[[:space:]]*"netio"[[:space:]]*$' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml should default traffic.type=netio" >&2
            exit 1
          fi
          if grep -Eq '^[[:space:]]*token:[[:space:]]*' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml should not contain legacy panel.token" >&2
            exit 1
          fi
          if grep -Eq '^[[:space:]]*node_id:[[:space:]]*' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml should not contain legacy panel.node_id" >&2
            exit 1
          fi

          if go run "${VALIDATE_GO}" "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml should fail validation before real token/address override" >&2
            exit 1
          fi

          python3 -c 'from pathlib import Path; import sys; text = Path(sys.argv[1]).read_text(); text = text.replace("host_token: \"\"", "host_token: \"release-check-token\"", 1); text = text.replace("address: \"\"", "address: \"127.0.0.1:19090\"", 1); Path(sys.argv[2]).write_text(text)' "${WORKDIR}/out/agent_config.yml" "${WORKDIR}/out/agent_config.runtime.yml"

          go run "${VALIDATE_GO}" "${WORKDIR}/out/agent_config.runtime.yml"
          rm -f "${VALIDATE_GO}" "${WORKDIR}/out/agent_config.runtime.yml"

      - name: Merge checksums
        run: |
          set -euo pipefail

          cat dist/release/*.sha256 > dist/release/SHA256SUMS.txt
          sha256sum deploy/agent.sh deploy/common.sh deploy/agent.service >> dist/release/SHA256SUMS.txt
          sort -k2 dist/release/SHA256SUMS.txt -o dist/release/SHA256SUMS.txt

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/release/xboard-*
            dist/release/agent-*
            dist/release/SHA256SUMS.txt
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}

  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build-binaries
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version info
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "major=$(echo $VERSION | cut -d. -f1)" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
