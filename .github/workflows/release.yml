name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

env:
  GO_VERSION: '1.25'
  NODE_VERSION: '20'

jobs:
  build-frontend:
    name: Build Frontend Assets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build User Frontend
        working-directory: web/user-vite
        run: |
          npm ci
          npm run build

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: web/user-vite/dist
          if-no-files-found: error

  build-binaries:
    name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
    runs-on: ubuntu-latest
    needs: build-frontend
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: linux
            goarch: amd64
            ext: ''
          - goos: linux
            goarch: arm64
            ext: ''
          - goos: darwin
            goarch: amd64
            ext: ''
          - goos: darwin
            goarch: arm64
            ext: ''
          - goos: windows
            goarch: amd64
            ext: '.exe'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: web/user-vite/dist

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get version info
        id: version
        run: |
          echo "version=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          echo "commit=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          echo "build_time=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_OUTPUT"

      - name: Build binaries
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          EXT: ${{ matrix.ext }}
        run: |
          set -euo pipefail

          mkdir -p dist/release

          XBOARD_BIN="xboard-${GOOS}-${GOARCH}${EXT}"
          AGENT_BIN="agent-${GOOS}-${GOARCH}${EXT}"

          echo "Building ${XBOARD_BIN}"
          go build -trimpath \
            -ldflags "-s -w -X main.Version=${{ steps.version.outputs.version }} -X main.Commit=${{ steps.version.outputs.commit }} -X main.BuildTime=${{ steps.version.outputs.build_time }}" \
            -o "dist/release/${XBOARD_BIN}" \
            ./cmd/xboard

          echo "Building ${AGENT_BIN}"
          go build -trimpath \
            -ldflags "-s -w" \
            -o "dist/release/${AGENT_BIN}" \
            ./cmd/agent

          sha256sum "dist/release/${XBOARD_BIN}" > "dist/release/${XBOARD_BIN}.sha256"
          sha256sum "dist/release/${AGENT_BIN}" > "dist/release/${AGENT_BIN}.sha256"

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/release/*
          if-no-files-found: error

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-binaries
    steps:
      - uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/release
          pattern: release-*
          merge-multiple: true

      - name: Verify expected binaries exist
        run: |
          set -euo pipefail
          test -f dist/release/xboard-linux-amd64
          test -f dist/release/xboard-linux-arm64
          test -f dist/release/xboard-darwin-amd64
          test -f dist/release/xboard-darwin-arm64
          test -f dist/release/xboard-windows-amd64.exe

          test -f dist/release/agent-linux-amd64
          test -f dist/release/agent-linux-arm64
          test -f dist/release/agent-darwin-amd64
          test -f dist/release/agent-darwin-arm64
          test -f dist/release/agent-windows-amd64.exe

      - name: Verify deploy script shell compatibility
        run: |
          set -euo pipefail

          sh -n deploy/install.sh deploy/panel.sh deploy/agent.sh
          bash -n deploy/install.sh deploy/panel.sh deploy/agent.sh

          WORKDIR_SH="$(mktemp -d)"
          WORKDIR_BASH="$(mktemp -d)"
          trap 'rm -rf "${WORKDIR_SH}" "${WORKDIR_BASH}"' EXIT

          cp dist/release/agent-linux-amd64 "${WORKDIR_SH}/agent"
          cp deploy/install.sh "${WORKDIR_SH}/install.sh"
          cp deploy/panel.sh "${WORKDIR_SH}/panel.sh"
          cp deploy/agent.sh "${WORKDIR_SH}/agent.sh"
          cp deploy/agent.service "${WORKDIR_SH}/agent.service"

          cp dist/release/agent-linux-amd64 "${WORKDIR_BASH}/agent"
          cp deploy/install.sh "${WORKDIR_BASH}/install.sh"
          cp deploy/panel.sh "${WORKDIR_BASH}/panel.sh"
          cp deploy/agent.sh "${WORKDIR_BASH}/agent.sh"
          cp deploy/agent.service "${WORKDIR_BASH}/agent.service"

          mkdir -p "${WORKDIR_SH}/local/local/releases/download/local" "${WORKDIR_BASH}/local/local/releases/download/local"
          cp dist/release/agent-linux-amd64 "${WORKDIR_SH}/local/local/releases/download/local/agent-linux-amd64"
          cp dist/release/agent-linux-amd64 "${WORKDIR_BASH}/local/local/releases/download/local/agent-linux-amd64"
          cp dist/release/xboard-linux-amd64 "${WORKDIR_SH}/local/local/releases/download/local/xboard-linux-amd64"
          cp dist/release/xboard-linux-amd64 "${WORKDIR_BASH}/local/local/releases/download/local/xboard-linux-amd64"

          AGENT_SHA="$(sha256sum dist/release/agent-linux-amd64 | awk '{print $1}')"
          XBOARD_SHA="$(sha256sum dist/release/xboard-linux-amd64 | awk '{print $1}')"
          SCRIPT_SHA="$(sha256sum deploy/agent.sh | awk '{print $1}')"
          SERVICE_SHA="$(sha256sum deploy/agent.service | awk '{print $1}')"
          printf '%s  %s\n%s  %s\n%s  %s\n%s  %s\n' \
            "${AGENT_SHA}" "agent-linux-amd64" \
            "${XBOARD_SHA}" "xboard-linux-amd64" \
            "${SCRIPT_SHA}" "agent.sh" \
            "${SERVICE_SHA}" "agent.service" \
            > "${WORKDIR_SH}/local/local/releases/download/local/SHA256SUMS.txt"
          cp "${WORKDIR_SH}/local/local/releases/download/local/SHA256SUMS.txt" "${WORKDIR_BASH}/local/local/releases/download/local/SHA256SUMS.txt"

          chmod +x "${WORKDIR_SH}/agent" "${WORKDIR_SH}/install.sh" "${WORKDIR_SH}/panel.sh" "${WORKDIR_SH}/agent.sh"
          chmod +x "${WORKDIR_BASH}/agent" "${WORKDIR_BASH}/install.sh" "${WORKDIR_BASH}/panel.sh" "${WORKDIR_BASH}/agent.sh"

          (
            cd "${WORKDIR_SH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/out" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            XBOARD_AGENT_HOST_TOKEN="workflow-token-sh" \
            XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
            sh ./install.sh --agent-only
            test -x "${WORKDIR_SH}/out/agent"
            test -f "${WORKDIR_SH}/out/agent_config.yml"
          )

          (
            cd "${WORKDIR_BASH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/out" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_BASH}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            XBOARD_AGENT_HOST_TOKEN="workflow-token-bash" \
            XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
            bash ./install.sh --agent-only
            test -x "${WORKDIR_BASH}/out/agent"
            test -f "${WORKDIR_BASH}/out/agent_config.yml"
          )

          (
            cd "${WORKDIR_SH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/panel-out" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            sh ./panel.sh
            test -x "${WORKDIR_SH}/panel-out/xboard"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/panel-out" XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" XBOARD_RELEASE_REPO="local/local" XBOARD_RELEASE_TAG="local" sh ./panel.sh --uninstall
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/panel-out" XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" XBOARD_RELEASE_REPO="local/local" XBOARD_RELEASE_TAG="local" sh ./panel.sh --uninstall
            test ! -e "${WORKDIR_SH}/panel-out/xboard"
            test ! -e "${WORKDIR_SH}/panel-out/config.yml"
            test ! -e "${WORKDIR_SH}/panel-out/.env"
            test ! -e "${WORKDIR_SH}/panel-out/web/user-vite/dist"
            test ! -e "${WORKDIR_SH}/panel-out/web/install"
          )

          (
            cd "${WORKDIR_BASH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/panel-out" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_BASH}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            bash ./panel.sh
            test -x "${WORKDIR_BASH}/panel-out/xboard"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/panel-out" XBOARD_RELEASE_BASE_URL="file://${WORKDIR_BASH}" XBOARD_RELEASE_REPO="local/local" XBOARD_RELEASE_TAG="local" bash ./panel.sh --uninstall
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/panel-out" XBOARD_RELEASE_BASE_URL="file://${WORKDIR_BASH}" XBOARD_RELEASE_REPO="local/local" XBOARD_RELEASE_TAG="local" bash ./panel.sh --uninstall
            test ! -e "${WORKDIR_BASH}/panel-out/xboard"
            test ! -e "${WORKDIR_BASH}/panel-out/config.yml"
            test ! -e "${WORKDIR_BASH}/panel-out/.env"
            test ! -e "${WORKDIR_BASH}/panel-out/web/user-vite/dist"
            test ! -e "${WORKDIR_BASH}/panel-out/web/install"
          )

          (
            cd "${WORKDIR_SH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/out" \
            sh ./agent.sh --uninstall
            sh ./agent.sh --uninstall
            test ! -e "${WORKDIR_SH}/out/agent"
            test ! -e "${WORKDIR_SH}/out/agent_config.yml"
          )

          (
            cd "${WORKDIR_BASH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/out" \
            bash ./agent.sh --uninstall
            bash ./agent.sh --uninstall
            test ! -e "${WORKDIR_BASH}/out/agent"
            test ! -e "${WORKDIR_BASH}/out/agent_config.yml"
          )

          (
            cd "${WORKDIR_SH}"
            mkdir -p "${WORKDIR_SH}/custom-install"
            touch "${WORKDIR_SH}/custom-install/unknown.keep"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/custom-install" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            XBOARD_AGENT_HOST_TOKEN="custom-token-sh" \
            XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
            sh ./agent.sh
            test -f "${WORKDIR_SH}/custom-install/unknown.keep"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/custom-install" \
            sh ./agent.sh --uninstall
            test -f "${WORKDIR_SH}/custom-install/unknown.keep"
            test ! -e "${WORKDIR_SH}/custom-install/agent"
            test ! -e "${WORKDIR_SH}/custom-install/agent_config.yml"
          )

          (
            cd "${WORKDIR_BASH}"
            mkdir -p "${WORKDIR_BASH}/custom-install"
            touch "${WORKDIR_BASH}/custom-install/unknown.keep"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/custom-install" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_BASH}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            XBOARD_AGENT_HOST_TOKEN="custom-token-bash" \
            XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
            bash ./agent.sh
            test -f "${WORKDIR_BASH}/custom-install/unknown.keep"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/custom-install" \
            bash ./agent.sh --uninstall
            test -f "${WORKDIR_BASH}/custom-install/unknown.keep"
            test ! -e "${WORKDIR_BASH}/custom-install/agent"
            test ! -e "${WORKDIR_BASH}/custom-install/agent_config.yml"
          )

          (
            cd "${WORKDIR_SH}"
            if XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/conflict-out" \
              sh ./agent.sh --uninstall --host-token "conflict-token" --grpc-address "127.0.0.1:19090"; then
              echo "agent.sh --uninstall should fail when mixed with install parameters" >&2
              exit 1
            fi
          )

          (
            cd "${WORKDIR_SH}"
            if XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/conflict-bootstrap-uninstall-out" \
              sh ./agent.sh --bootstrap --uninstall; then
              echo "agent.sh --bootstrap --uninstall should fail" >&2
              exit 1
            fi
          )

          (
            cd "${WORKDIR_BASH}"
            if XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/conflict-bootstrap-uninstall-out" \
              bash ./agent.sh --bootstrap --uninstall; then
              echo "agent.sh --bootstrap --uninstall should fail under bash" >&2
              exit 1
            fi
          )

          (
            cd "${WORKDIR_SH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/install-full-out" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            XBOARD_AGENT_HOST_TOKEN="install-full-token-sh" \
            XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
            sh ./install.sh --full
            test -x "${WORKDIR_SH}/install-full-out/xboard"
            test -x "${WORKDIR_SH}/install-full-out/agent"
            test -f "${WORKDIR_SH}/install-full-out/agent_config.yml"
            sh ./install.sh --full --uninstall
            sh ./install.sh --full --uninstall
            test ! -e "${WORKDIR_SH}/install-full-out/xboard"
            test ! -e "${WORKDIR_SH}/install-full-out/agent"
            test ! -e "${WORKDIR_SH}/install-full-out/agent_config.yml"
          )

          (
            cd "${WORKDIR_BASH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/install-full-out" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_BASH}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            XBOARD_AGENT_HOST_TOKEN="install-full-token-bash" \
            XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
            bash ./install.sh --full
            test -x "${WORKDIR_BASH}/install-full-out/xboard"
            test -x "${WORKDIR_BASH}/install-full-out/agent"
            test -f "${WORKDIR_BASH}/install-full-out/agent_config.yml"
            bash ./install.sh --full --uninstall
            bash ./install.sh --full --uninstall
            test ! -e "${WORKDIR_BASH}/install-full-out/xboard"
            test ! -e "${WORKDIR_BASH}/install-full-out/agent"
            test ! -e "${WORKDIR_BASH}/install-full-out/agent_config.yml"
          )

          (
            cd "${WORKDIR_SH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/install-panel-out" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            sh ./install.sh --panel-only
            test -x "${WORKDIR_SH}/install-panel-out/xboard"
            sh ./install.sh --panel-only --uninstall
            sh ./install.sh --panel-only --uninstall
            test ! -e "${WORKDIR_SH}/install-panel-out/xboard"
          )

          (
            cd "${WORKDIR_BASH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/install-panel-out" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_BASH}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            bash ./install.sh --panel-only
            test -x "${WORKDIR_BASH}/install-panel-out/xboard"
            bash ./install.sh --panel-only --uninstall
            bash ./install.sh --panel-only --uninstall
            test ! -e "${WORKDIR_BASH}/install-panel-out/xboard"
          )

          (
            cd "${WORKDIR_SH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/install-agent-out" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            XBOARD_AGENT_HOST_TOKEN="install-agent-token-sh" \
            XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
            sh ./install.sh --agent-only
            test -x "${WORKDIR_SH}/install-agent-out/agent"
            test -f "${WORKDIR_SH}/install-agent-out/agent_config.yml"
            sh ./install.sh --agent-only --uninstall
            sh ./install.sh --agent-only --uninstall
            test ! -e "${WORKDIR_SH}/install-agent-out/agent"
            test ! -e "${WORKDIR_SH}/install-agent-out/agent_config.yml"
          )

          (
            cd "${WORKDIR_BASH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/install-agent-out" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_BASH}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            XBOARD_AGENT_HOST_TOKEN="install-agent-token-bash" \
            XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
            bash ./install.sh --agent-only
            test -x "${WORKDIR_BASH}/install-agent-out/agent"
            test -f "${WORKDIR_BASH}/install-agent-out/agent_config.yml"
            bash ./install.sh --agent-only --uninstall
            bash ./install.sh --agent-only --uninstall
            test ! -e "${WORKDIR_BASH}/install-agent-out/agent"
            test ! -e "${WORKDIR_BASH}/install-agent-out/agent_config.yml"
          )

          (
            cd "${WORKDIR_SH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/bootstrap-out" XBOARD_BOOTSTRAP_REF=local \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
            XBOARD_BOOTSTRAP_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
            XBOARD_AGENT_SCRIPT_URL="file://${WORKDIR_SH}/agent.sh" \
            XBOARD_AGENT_HOST_TOKEN="bootstrap-token-sh" \
            XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
            sh ./agent.sh --bootstrap \
              --repo local/local \
              --service-url "file://${WORKDIR_SH}/agent.service"
            test -x "${WORKDIR_SH}/bootstrap-out/agent"
            test -f "${WORKDIR_SH}/bootstrap-out/agent_config.yml"
          )

          (
            cd "${WORKDIR_BASH}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_BASH}/bootstrap-out" XBOARD_BOOTSTRAP_REF=local \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR_BASH}" \
            XBOARD_BOOTSTRAP_RELEASE_BASE_URL="file://${WORKDIR_BASH}" \
            XBOARD_AGENT_SCRIPT_URL="file://${WORKDIR_BASH}/agent.sh" \
            XBOARD_AGENT_HOST_TOKEN="bootstrap-token-bash" \
            XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
            bash ./agent.sh --bootstrap \
              --repo local/local \
              --service-url "file://${WORKDIR_BASH}/agent.service"
            test -x "${WORKDIR_BASH}/bootstrap-out/agent"
            test -f "${WORKDIR_BASH}/bootstrap-out/agent_config.yml"
          )

          cp "${WORKDIR_SH}/agent.service" "${WORKDIR_SH}/agent.service.bad"
          printf '\n# checksum mismatch fixture\n' >> "${WORKDIR_SH}/agent.service.bad"

          (
            cd "${WORKDIR_SH}"
            if XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/bootstrap-checksum-fail-out" XBOARD_BOOTSTRAP_REF=local \
              XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
              XBOARD_BOOTSTRAP_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
              XBOARD_AGENT_SCRIPT_URL="file://${WORKDIR_SH}/agent.sh" \
              XBOARD_AGENT_HOST_TOKEN="bootstrap-checksum-token" \
              XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
              sh ./agent.sh --bootstrap \
                --repo local/local \
                --service-url "file://${WORKDIR_SH}/agent.service.bad"; then
              echo "agent.sh --bootstrap should fail when agent.service checksum mismatches" >&2
              exit 1
            fi
          )

          (
            cd "${WORKDIR_SH}"
            if XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/bootstrap-download-fail-out" XBOARD_BOOTSTRAP_REF=local \
              XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
              XBOARD_BOOTSTRAP_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
              XBOARD_AGENT_SCRIPT_URL="file://${WORKDIR_SH}/agent.sh" \
              XBOARD_AGENT_HOST_TOKEN="bootstrap-download-token" \
              XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
              sh ./agent.sh --bootstrap \
                --repo local/local \
                --service-url "file://${WORKDIR_SH}/missing-agent.service"; then
              echo "agent.sh --bootstrap should fail when agent.service download fails" >&2
              exit 1
            fi
          )

          (
            cd "${WORKDIR_SH}"
            if XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR_SH}/install-download-fail-out" \
              XBOARD_RELEASE_BASE_URL="file://${WORKDIR_SH}" \
              XBOARD_RELEASE_REPO="local/local" \
              XBOARD_RELEASE_TAG="missing" \
              XBOARD_AGENT_HOST_TOKEN="strict-install-token" \
              XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
              sh ./install.sh --agent-only; then
              echo "install.sh --agent-only should fail when release binary download fails" >&2
              exit 1
            fi
          )

      - name: Set up Go for install config check
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Verify install config compatibility
        run: |
          set -euo pipefail

          WORKDIR="$(mktemp -d)"
          VALIDATE_GO="${GITHUB_WORKSPACE}/tmp_validate_agent_config.go"
          trap 'rm -rf "${WORKDIR}"; rm -f "${VALIDATE_GO}"' EXIT

          cp dist/release/agent-linux-amd64 "${WORKDIR}/agent"
          cp deploy/install.sh "${WORKDIR}/install.sh"
          cp deploy/panel.sh "${WORKDIR}/panel.sh"
          cp deploy/agent.sh "${WORKDIR}/agent.sh"

          mkdir -p "${WORKDIR}/local/local/releases/download/local"
          cp dist/release/agent-linux-amd64 "${WORKDIR}/local/local/releases/download/local/agent-linux-amd64"
          AGENT_SHA="$(sha256sum dist/release/agent-linux-amd64 | awk '{print $1}')"
          printf '%s  %s\n' "${AGENT_SHA}" "agent-linux-amd64" > "${WORKDIR}/local/local/releases/download/local/SHA256SUMS.txt"

          chmod +x "${WORKDIR}/agent" "${WORKDIR}/install.sh" "${WORKDIR}/panel.sh" "${WORKDIR}/agent.sh"

          (
            cd "${WORKDIR}"
            XBOARD_INSTALL_SKIP_SYSTEMD=1 INSTALL_DIR="${WORKDIR}/out" \
            XBOARD_RELEASE_BASE_URL="file://${WORKDIR}" \
            XBOARD_RELEASE_REPO="local/local" \
            XBOARD_RELEASE_TAG="local" \
            XBOARD_AGENT_HOST_TOKEN="release-check-token" \
            XBOARD_AGENT_GRPC_ADDRESS="127.0.0.1:19090" \
            sh ./install.sh --agent-only
            test -f "${WORKDIR}/out/agent_config.yml"
          )

          cat > "${VALIDATE_GO}" <<'EOF'
          package main

          import (
            "fmt"
            "os"

            agentcfg "github.com/creamcroissant/xboard/internal/agent/config"
          )

          func main() {
            if len(os.Args) != 2 {
              fmt.Fprintln(os.Stderr, "usage: validate_agent_config <path>")
              os.Exit(2)
            }
            if _, err := agentcfg.Load(os.Args[1]); err != nil {
              fmt.Fprintln(os.Stderr, err)
              os.Exit(1)
            }
          }
          EOF

          if ! grep -Eq '^[[:space:]]*grpc:' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml missing grpc section" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*enabled:[[:space:]]*true[[:space:]]*$' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml missing grpc.enabled=true" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*enabled:[[:space:]]*false[[:space:]]*$' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml should default grpc.tls.enabled=false" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*address:[[:space:]]*"127\.0\.0\.1:19090"[[:space:]]*$' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml grpc.address should be initialized from install parameters" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*panel:' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml missing panel section" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*host_token:[[:space:]]*"release-check-token"[[:space:]]*$' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml panel.host_token should be initialized from install parameters" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*traffic:' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml missing traffic section" >&2
            exit 1
          fi
          if ! grep -Eq '^[[:space:]]*type:[[:space:]]*"netio"[[:space:]]*$' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml should default traffic.type=netio" >&2
            exit 1
          fi
          if grep -Eq '^[[:space:]]*token:[[:space:]]*' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml should not contain legacy panel.token" >&2
            exit 1
          fi
          if grep -Eq '^[[:space:]]*node_id:[[:space:]]*' "${WORKDIR}/out/agent_config.yml"; then
            echo "agent_config.yml should not contain legacy panel.node_id" >&2
            exit 1
          fi

          go run "${VALIDATE_GO}" "${WORKDIR}/out/agent_config.yml"
          rm -f "${VALIDATE_GO}"

      - name: Merge checksums
        run: |
          set -euo pipefail

          cat dist/release/*.sha256 > dist/release/SHA256SUMS.txt
          sha256sum deploy/agent.sh deploy/agent.service >> dist/release/SHA256SUMS.txt
          sort -k2 dist/release/SHA256SUMS.txt -o dist/release/SHA256SUMS.txt

      - name: Verify bootstrap checksum entries
        run: |
          set -euo pipefail

          grep -Eq '[[:space:]]deploy/agent\.sh$' dist/release/SHA256SUMS.txt
          grep -Eq '[[:space:]]deploy/agent\.service$' dist/release/SHA256SUMS.txt

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/release/xboard-*
            dist/release/agent-*
            dist/release/SHA256SUMS.txt
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}

  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build-binaries
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version info
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "major=$(echo $VERSION | cut -d. -f1)" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
